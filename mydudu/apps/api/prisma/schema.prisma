generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// ENUMS
// ============================================================

enum UserRole {
  ADMIN
  POSYANDU
  PUSKESMAS
  PARENT

  @@map("user_role")
}

enum UserStatus {
  ACTIVE
  PENDING
  SUSPENDED

  @@map("user_status")
}

enum DeviceStatus {
  AVAILABLE
  WAITING
  INACTIVE

  @@map("device_connectivity_status")
}

enum SessionStatus {
  IN_PROGRESS
  COMPLETE
  CLINICALLY_SUFFICIENT
  INSUFFICIENT

  @@map("session_status")
}

enum NutritionCategory {
  NORMAL
  STUNTED
  WASTED
  OBESE

  @@map("nutrition_category")
}

enum ValidationStatus {
  OK
  WARN
  FAIL

  @@map("validation_status")
}

enum NotifType {
  RESULT
  REMINDER
  SYSTEM

  @@map("notif_type")
}

enum NotifStatus {
  SENT
  READ

  @@map("notif_status")
}

// ============================================================
// LOCATION HIERARCHY
// ============================================================

model District {
  id       Int       @id @default(autoincrement())
  name     String    @db.VarChar(100)
  code     String?   @unique @db.VarChar(20)
  villages Village[]
  users    User[]

  @@map("districts")
}

model Village {
  id         Int        @id @default(autoincrement())
  districtId Int        @map("district_id")
  name       String     @db.VarChar(100)
  code       String?    @unique @db.VarChar(20)
  district   District   @relation(fields: [districtId], references: [id], onDelete: Cascade)
  posyandus  Posyandu[]
  users      User[]
  Parent     Parent[]

  @@map("villages")
}

model Posyandu {
  id        Int     @id @default(autoincrement())
  villageId Int     @map("village_id")
  name      String  @db.VarChar(100)
  address   String? @db.Text
  village   Village @relation(fields: [villageId], references: [id], onDelete: Cascade)

  devices   Device[]
  schedules Schedule[]

  @@map("posyandus")
}

// ============================================================
// USERS
// ============================================================

model User {
  id             Int        @id @default(autoincrement())
  fullName       String     @map("full_name") @db.VarChar(100)
  email          String?    @unique @db.VarChar(100)
  phoneNumber    String?    @map("phone_number") @db.VarChar(20)
  role           UserRole   @default(PARENT)
  status         UserStatus @default(ACTIVE)
  profilePicture String?    @map("profile_picture") @db.Text
  villageId      Int?       @map("village_id")
  districtId     Int?       @map("district_id")
  createdAt      DateTime?  @default(now()) @map("created_at") @db.Timestamp(6)
  lastLogin      DateTime?  @map("last_login") @db.Timestamp(6)

  village           Village?           @relation(fields: [villageId], references: [id])
  district          District?          @relation(fields: [districtId], references: [id])
  parentProfile     Parent?
  assignedIncidents Incident[]
  operatorSessions  Session[]
  validatedRecords  ValidationRecord[]
  notifications     Notification[]
  createdSchedules  Schedule[]
  auditLogs         AuditLog[]

  @@unique([fullName, phoneNumber], map: "idx_unique_fullname_phone")
  @@index([role], map: "idx_users_role")
  @@map("users")
}

// ============================================================
// PARENT PROFILES
// ============================================================

model Parent {
  id        Int      @id @default(autoincrement())
  parentId  Int      @unique @map("parent_id")
  villageId Int?     @map("village_id")
  latitude  Decimal? @db.Decimal(9, 6)
  longitude Decimal? @db.Decimal(9, 6)

  user     User     @relation(fields: [parentId], references: [id], onDelete: Cascade)
  village  Village? @relation(fields: [villageId], references: [id])
  children Child[]

  @@map("parents")
}

// ============================================================
// CHILDREN
// ============================================================

model Child {
  id        Int       @id @default(autoincrement())
  parentId  Int       @map("parent_id")
  fullName  String    @map("full_name") @db.VarChar(100)
  birthDate DateTime  @map("birth_date") @db.Date
  gender    String?   @db.Char(1) // 'M' or 'F'
  bloodType String?   @map("blood_type") @db.VarChar(10) // A, B, AB, O, UNKNOWN
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamp(6)

  parent   Parent    @relation(fields: [parentId], references: [id], onDelete: Cascade)
  sessions Session[]

  @@map("children")
}

// ============================================================
// DEVICES
// ============================================================

model Device {
  id         Int          @id @default(autoincrement())
  deviceUuid String       @unique @map("device_uuid") @db.VarChar(64)
  name       String       @db.VarChar(50)
  posyanduId Int?         @map("posyandu_id")
  status     DeviceStatus @default(INACTIVE) @map("status")
  // batteryLevel Int?         @map("battery_level") @db.SmallInt // Removed
  // lastSync     DateTime?    @map("last_sync") @db.Timestamp(6) // Removed

  posyandu  Posyandu?  @relation(fields: [posyanduId], references: [id])
  // logs      DeviceLog[] // Removed
  incidents Incident[]
  sessions  Session[]

  @@map("devices")
}

// ============================================================
// DEVICE LOGS - REMOVED
// ============================================================

// model DeviceLog { ... }

// ============================================================
// INCIDENT MANAGEMENT
// ============================================================

model Incident {
  id          Int       @id @default(autoincrement())
  deviceId    Int?      @map("device_id")
  title       String    @db.VarChar(100)
  description String?   @db.Text
  priority    String?   @db.VarChar(10) // LOW, MEDIUM, HIGH
  status      String?   @default("OPEN") @db.VarChar(15) // OPEN, IN_PROGRESS, RESOLVED, CLOSED
  assignedTo  Int?      @map("assigned_to")
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  resolvedAt  DateTime? @map("resolved_at") @db.Timestamp(6)

  device   Device? @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  assignee User?   @relation(fields: [assignedTo], references: [id], onDelete: SetNull)

  @@map("incidents")
}

// ============================================================
// SESSIONS
// ============================================================

model Session {
  id          Int           @id @default(autoincrement())
  sessionUuid String        @unique @map("session_uuid") @db.VarChar(64)
  childId     Int           @map("child_id")
  deviceId    Int           @map("device_id")
  operatorId  Int?          @map("operator_id")
  recordedAt  DateTime?     @map("recorded_at") @db.Timestamp(6)
  status      SessionStatus @default(IN_PROGRESS)

  // Metrics
  weight      Decimal? @db.Decimal(5, 2)
  height      Decimal? @db.Decimal(5, 2)
  temperature Decimal? @db.Decimal(4, 2)
  // headCirc     Decimal?      @map("head_circ") @db.Decimal(5, 2)
  // armCirc      Decimal?      @map("arm_circ") @db.Decimal(5, 2)
  heartRate   Decimal? @map("heart_rate") @db.Decimal(5, 2)
  noiseLevel  Decimal? @map("noise_level") @db.Decimal(5, 2)
  // oxy          Decimal?      @db.Decimal(5, 2)

  child    Child  @relation(fields: [childId], references: [id], onDelete: Cascade)
  device   Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  operator User?  @relation(fields: [operatorId], references: [id], onDelete: SetNull)

  nutritionStatuses NutritionStatus[]
  validationRecords ValidationRecord[]
  reports           Report[]
  geotags           Geotag[]

  @@index([childId], map: "idx_sessions_child_id")
  @@index([status], map: "idx_sessions_status")
  @@map("sessions")
}

// ============================================================
// MEASUREMENTS - REMOVED (Merged into Session)
// ============================================================

// model Measurement { ... }

// ============================================================
// NUTRITION STATUS
// ============================================================

model NutritionStatus {
  id        Int                @id @default(autoincrement())
  sessionId Int                @map("session_id")
  bbU       Decimal?           @map("bb_u") @db.Decimal(5, 2)
  tbU       Decimal?           @map("tb_u") @db.Decimal(5, 2)
  bbTb      Decimal?           @map("bb_tb") @db.Decimal(5, 2)
  category  NutritionCategory?

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("nutrition_status")
}

// ============================================================
// VALIDATION RECORDS
// ============================================================

model ValidationRecord {
  id          Int       @id @default(autoincrement())
  sessionId   Int       @map("session_id")
  validatorId Int?      @map("validator_id")
  validatedAt DateTime? @default(now()) @map("validated_at") @db.Timestamp(6)
  remarks     String?   @db.Text

  session   Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  validator User?   @relation(fields: [validatorId], references: [id], onDelete: SetNull)

  @@map("validation_records")
}

// ============================================================
// REPORTS
// ============================================================

model Report {
  id          Int       @id @default(autoincrement())
  sessionId   Int       @map("session_id")
  fileUrl     String    @map("file_url") @db.Text
  generatedAt DateTime? @default(now()) @map("generated_at") @db.Timestamp(6)

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("reports")
}

// ============================================================
// NOTIFICATIONS
// ============================================================

model Notification {
  id        Int         @id @default(autoincrement())
  userId    Int         @map("user_id")
  type      NotifType
  message   String      @db.Text
  status    NotifStatus @default(SENT)
  createdAt DateTime?   @default(now()) @map("created_at") @db.Timestamp(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// ============================================================
// EDUCATION CONTENT (CMS)
// ============================================================

model EducationArticle {
  id        Int       @id @default(autoincrement())
  title     String    @db.VarChar(150)
  content   String    @db.Text
  category  String?   @db.VarChar(50)
  imageUrl  String?   @map("image_url") @db.Text
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt DateTime? @default(now()) @map("updated_at") @db.Timestamp(6)

  @@map("education_articles")
}

// ============================================================
// SCHEDULE / EVENTS
// ============================================================

model Schedule {
  id          Int       @id @default(autoincrement())
  posyanduId  Int?      @map("posyandu_id")
  title       String    @db.VarChar(100)
  description String?   @db.Text
  eventDate   DateTime  @map("event_date") @db.Date
  startTime   DateTime? @map("start_time") @db.Time
  endTime     DateTime? @map("end_time") @db.Time
  createdBy   Int?      @map("created_by")

  posyandu Posyandu? @relation(fields: [posyanduId], references: [id], onDelete: Cascade)
  creator  User?     @relation(fields: [createdBy], references: [id], onDelete: SetNull)

  @@map("schedules")
}

// ============================================================
// AUDIT LOGS
// ============================================================

model AuditLog {
  id        BigInt    @id @default(autoincrement())
  userId    Int?      @map("user_id")
  action    String    @db.VarChar(100)
  details   Json?
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamp(6)

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt(sort: Desc)], map: "idx_audit_logs_user_time")
  @@map("audit_logs")
}

// ============================================================
// GEOTAGS
// ============================================================

model Geotag {
  id        Int      @id @default(autoincrement())
  sessionId Int      @map("session_id")
  latitude  Decimal? @db.Decimal(9, 6)
  longitude Decimal? @db.Decimal(9, 6)

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("geotags")
}
