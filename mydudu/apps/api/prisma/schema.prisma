generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// ENUMS
// ============================================================

enum UserRole {
  ADMIN
  POSYANDU
  PUSKESMAS
  PARENT

  @@map("user_role")
}

enum UserStatus {
  ACTIVE
  PENDING
  SUSPENDED

  @@map("user_status")
}

enum DeviceStatus {
  AVAILABLE
  WAITING
  INACTIVE

  @@map("device_connectivity_status")
}

enum SessionStatus {
  IN_PROGRESS
  COMPLETE
  CLINICALLY_SUFFICIENT
  INSUFFICIENT

  @@map("session_status")
}

enum ExamOutcome {
  PENDING
  DIAGNOSED
  CANCELED
  REFER_IMMEDIATELY
  EMERGENCY
  EXCLUDED

  @@map("exam_outcome")
}

enum DiagnosisCode {
  PNEUMONIA
  DENGUE
  DIARRHEA_SEVERE
  HEALTHY
  OTHER

  @@map("diagnosis_code")
}

enum NutritionCategory {
  NORMAL
  STUNTED
  WASTED
  OBESE

  @@map("nutrition_category")
}

enum ValidationStatus {
  OK
  WARN
  FAIL

  @@map("validation_status")
}

enum NotifType {
  RESULT
  REMINDER
  SYSTEM

  @@map("notif_type")
}

enum NotifStatus {
  SENT
  READ

  @@map("notif_status")
}

// ============================================================
// LOCATION HIERARCHY
// ============================================================

model District {
  id       Int       @id @default(autoincrement())
  name     String    @db.VarChar(100)
  code     String?   @unique @db.VarChar(20)
  villages Village[]
  users    User[]

  @@map("districts")
}

model Village {
  id         Int        @id @default(autoincrement())
  districtId Int        @map("district_id")
  name       String     @db.VarChar(100)
  code       String?    @unique @db.VarChar(20)
  district   District   @relation(fields: [districtId], references: [id], onDelete: Cascade)
  posyandus  Posyandu[]
  users      User[]
  Parent     Parent[]

  @@map("villages")
}

model Posyandu {
  id        Int     @id @default(autoincrement())
  villageId Int     @map("village_id")
  name      String  @db.VarChar(100)
  address   String? @db.Text
  village   Village @relation(fields: [villageId], references: [id], onDelete: Cascade)

  devices   Device[]
  schedules Schedule[]

  @@map("posyandus")
}

// ============================================================
// USERS
// ============================================================

model User {
  id             Int        @id @default(autoincrement())
  fullName       String     @map("full_name") @db.VarChar(100)
  email          String?    @unique @db.VarChar(100)
  phoneNumber    String?    @map("phone_number") @db.VarChar(20)
  role           UserRole   @default(PARENT)
  status         UserStatus @default(ACTIVE)
  profilePicture String?    @map("profile_picture") @db.Text
  villageId      Int?       @map("village_id")
  districtId     Int?       @map("district_id")
  createdAt      DateTime?  @default(now()) @map("created_at") @db.Timestamp(6)
  lastLogin      DateTime?  @map("last_login") @db.Timestamp(6)

  village           Village?           @relation(fields: [villageId], references: [id])
  district          District?          @relation(fields: [districtId], references: [id])
  parentProfile     Parent?
  assignedIncidents Incident[]
  operatorSessions  Session[]          @relation("session_operator")
  lockedSessions    Session[]          @relation("session_lock_owner")
  validatedRecords  ValidationRecord[]
  notifications     Notification[]
  createdSchedules  Schedule[]
  auditLogs         AuditLog[]

  // Clinical Engine
  createdClinicalTrees  ClinicalDecisionTree[] 
  reviewedClinicalTrees ClinicalDecisionTree[] @relation("tree_reviews")
  reviewedTreeExpansions TreeExpansionProposal[] @relation("tree_expansion_reviewer")

  @@unique([fullName, phoneNumber], map: "idx_unique_fullname_phone")
  @@index([role], map: "idx_users_role")
  @@map("users")
}

// ============================================================
// PARENT PROFILES
// ============================================================

model Parent {
  id        Int      @id @default(autoincrement())
  parentId  Int      @unique @map("parent_id")
  villageId Int?     @map("village_id")
  latitude  Decimal? @db.Decimal(9, 6)
  longitude Decimal? @db.Decimal(9, 6)

  user     User     @relation(fields: [parentId], references: [id], onDelete: Cascade)
  village  Village? @relation(fields: [villageId], references: [id])
  children Child[]

  @@map("parents")
}

// ============================================================
// CHILDREN
// ============================================================

model Child {
  id        Int       @id @default(autoincrement())
  childUuid String    @unique @default(uuid()) @map("child_uuid") @db.VarChar(64)
  parentId  Int       @map("parent_id")
  fullName  String    @map("full_name") @db.VarChar(100)
  birthDate DateTime  @map("birth_date") @db.Date
  gender    String?   @db.Char(1) // 'M' or 'F'
  bloodType String?   @map("blood_type") @db.VarChar(10) // A, B, AB, O, UNKNOWN
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamp(6)

  parent   Parent    @relation(fields: [parentId], references: [id], onDelete: Cascade)
  sessions Session[]

  @@map("children")
}

// ============================================================
// DEVICES
// ============================================================

model Device {
  id         Int          @id @default(autoincrement())
  deviceUuid String       @unique @map("device_uuid") @db.VarChar(64)
  name       String       @db.VarChar(50)
  posyanduId Int?         @map("posyandu_id")
  status     DeviceStatus @default(INACTIVE) @map("status")
  // batteryLevel Int?         @map("battery_level") @db.SmallInt // Removed
  // lastSync     DateTime?    @map("last_sync") @db.Timestamp(6) // Removed

  posyandu  Posyandu?  @relation(fields: [posyanduId], references: [id])
  // logs      DeviceLog[] // Removed
  incidents Incident[]
  sessions  Session[]

  @@map("devices")
}

// ============================================================
// DEVICE LOGS - REMOVED
// ============================================================

// model DeviceLog { ... }

// ============================================================
// INCIDENT MANAGEMENT
// ============================================================

model Incident {
  id          Int       @id @default(autoincrement())
  deviceId    Int?      @map("device_id")
  title       String    @db.VarChar(100)
  description String?   @db.Text
  priority    String?   @db.VarChar(10) // LOW, MEDIUM, HIGH
  status      String?   @default("OPEN") @db.VarChar(15) // OPEN, IN_PROGRESS, RESOLVED, CLOSED
  assignedTo  Int?      @map("assigned_to")
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  resolvedAt  DateTime? @map("resolved_at") @db.Timestamp(6)

  device   Device? @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  assignee User?   @relation(fields: [assignedTo], references: [id], onDelete: SetNull)

  @@map("incidents")
}

// ============================================================
// SESSIONS
// ============================================================

model Session {
  id          Int           @id @default(autoincrement())
  sessionUuid String        @unique @map("session_uuid") @db.VarChar(64)
  childId     Int           @map("child_id")
  deviceId    Int           @map("device_id")
  operatorId  Int?          @map("operator_id")
  recordedAt  DateTime?     @map("recorded_at") @db.Timestamp(6)
  status      SessionStatus @default(IN_PROGRESS)
  examOutcome ExamOutcome   @default(PENDING) @map("exam_outcome")
  diagnosisCode DiagnosisCode? @map("diagnosis_code")
  diagnosisText String?     @map("diagnosis_text") @db.VarChar(255)
  measurementCompleted Boolean   @default(false) @map("measurement_completed")
  measurementCompletedAt DateTime? @map("measurement_completed_at") @db.Timestamp(6)
  lockedByOperatorId Int?   @map("locked_by_operator_id")
  lockedAt   DateTime?      @map("locked_at") @db.Timestamp(6)
  lockToken  String?        @map("lock_token") @db.VarChar(64)
  version    Int            @default(1)
  treeVersion String?       @map("tree_version") @db.VarChar(64) // Added for version locking
  snapshotNodes Json?       @map("snapshot_nodes") // PHASE 9: Immutable tree snapshot
  updatedAt  DateTime       @updatedAt @map("updated_at") @db.Timestamp(6)

  // Metrics
  weight      Decimal? @db.Decimal(5, 2)
  height      Decimal? @db.Decimal(5, 2)
  temperature Decimal? @db.Decimal(4, 2)
  // headCirc     Decimal?      @map("head_circ") @db.Decimal(5, 2)
  // armCirc      Decimal?      @map("arm_circ") @db.Decimal(5, 2)
  heartRate   Decimal? @map("heart_rate") @db.Decimal(5, 2)
  noiseLevel  Decimal? @map("noise_level") @db.Decimal(5, 2)
  // oxy          Decimal?      @db.Decimal(5, 2)

  child    Child  @relation(fields: [childId], references: [id], onDelete: Cascade)
  device   Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  operator User?  @relation("session_operator", fields: [operatorId], references: [id], onDelete: SetNull)
  lockedByOperator User? @relation("session_lock_owner", fields: [lockedByOperatorId], references: [id], onDelete: SetNull)

  nutritionStatuses NutritionStatus[]
  validationRecords ValidationRecord[]
  reports           Report[]
  geotags           Geotag[]
  quizSteps         SessionQuizStep[]

  @@index([childId], map: "idx_sessions_child_id")
  @@index([status], map: "idx_sessions_status")
  @@index([examOutcome, measurementCompleted, recordedAt], map: "idx_sessions_queue")
  @@index([lockedByOperatorId], map: "idx_sessions_lock_owner")
  @@index([measurementCompletedAt], map: "idx_sessions_measurement_completed_at")
  @@map("sessions")
}

model SessionQuizStep {
  id         Int      @id @default(autoincrement())
  sessionId  Int      @map("session_id")
  stepOrder  Int      @map("step_order")
  nodeId     String   @map("node_id") @db.VarChar(64)
  question   String   @db.Text
  answerYes  Boolean  @map("answer_yes")
  nextNodeId String?  @map("next_node_id") @db.VarChar(64)
  treeVersion String  @default("decision-tree-v1") @map("tree_version") @db.VarChar(64)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, stepOrder], map: "uq_session_quiz_steps_order")
  @@index([sessionId], map: "idx_session_quiz_steps_session")
  @@map("session_quiz_steps")
}

// ============================================================
// MEASUREMENTS - REMOVED (Merged into Session)
// ============================================================

// model Measurement { ... }

// ============================================================
// NUTRITION STATUS
// ============================================================

model NutritionStatus {
  id        Int                @id @default(autoincrement())
  sessionId Int                @map("session_id")
  bbU       Decimal?           @map("bb_u") @db.Decimal(5, 2)
  tbU       Decimal?           @map("tb_u") @db.Decimal(5, 2)
  bbTb      Decimal?           @map("bb_tb") @db.Decimal(5, 2)
  category  NutritionCategory?

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("nutrition_status")
}

// ============================================================
// VALIDATION RECORDS
// ============================================================

model ValidationRecord {
  id          Int       @id @default(autoincrement())
  sessionId   Int       @map("session_id")
  validatorId Int?      @map("validator_id")
  validatedAt DateTime? @default(now()) @map("validated_at") @db.Timestamp(6)
  remarks     String?   @db.Text

  session   Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  validator User?   @relation(fields: [validatorId], references: [id], onDelete: SetNull)

  @@map("validation_records")
}

// ============================================================
// REPORTS
// ============================================================

model Report {
  id          Int       @id @default(autoincrement())
  sessionId   Int       @map("session_id")
  fileUrl     String    @map("file_url") @db.Text
  generatedAt DateTime? @default(now()) @map("generated_at") @db.Timestamp(6)

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("reports")
}

// ============================================================
// NOTIFICATIONS
// ============================================================

model Notification {
  id        Int         @id @default(autoincrement())
  userId    Int         @map("user_id")
  type      NotifType
  message   String      @db.Text
  status    NotifStatus @default(SENT)
  createdAt DateTime?   @default(now()) @map("created_at") @db.Timestamp(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// ============================================================
// EDUCATION CONTENT (CMS)
// ============================================================

model EducationArticle {
  id        Int       @id @default(autoincrement())
  title     String    @db.VarChar(150)
  content   String    @db.Text
  category  String?   @db.VarChar(50)
  imageUrl  String?   @map("image_url") @db.Text
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt DateTime? @default(now()) @map("updated_at") @db.Timestamp(6)

  @@map("education_articles")
}

// ============================================================
// SCHEDULE / EVENTS
// ============================================================

model Schedule {
  id          Int       @id @default(autoincrement())
  posyanduId  Int?      @map("posyandu_id")
  title       String    @db.VarChar(100)
  description String?   @db.Text
  eventDate   DateTime  @map("event_date") @db.Date
  startTime   DateTime? @map("start_time") @db.Time
  endTime     DateTime? @map("end_time") @db.Time
  createdBy   Int?      @map("created_by")

  posyandu Posyandu? @relation(fields: [posyanduId], references: [id], onDelete: Cascade)
  creator  User?     @relation(fields: [createdBy], references: [id], onDelete: SetNull)

  @@map("schedules")
}

// ============================================================
// AUDIT LOGS
// ============================================================

model AuditLog {
  id        BigInt    @id @default(autoincrement())
  userId    Int?      @map("user_id")
  action    String    @db.VarChar(100)
  details   Json?
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamp(6)

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt(sort: Desc)], map: "idx_audit_logs_user_time")
  @@map("audit_logs")
}

// ============================================================
// GEOTAGS
// ============================================================

model Geotag {
  id        Int      @id @default(autoincrement())
  sessionId Int      @map("session_id")
  latitude  Decimal? @db.Decimal(9, 6)
  longitude Decimal? @db.Decimal(9, 6)

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("geotags")
}

// ============================================================
// WHO GROWTH STANDARDS
// ============================================================

enum WhoGender {
  M
  F

  @@map("who_gender")
}

enum WhoGrowthIndicator {
  WEIGHT_FOR_AGE
  WEIGHT_FOR_HEIGHT
  WEIGHT_FOR_LENGTH
  LENGTH_HEIGHT_FOR_AGE
  BMI_FOR_AGE

  @@map("who_growth_indicator")
}

model WhoGrowthStandard {
  id        Int                @id @default(autoincrement())
  indicator WhoGrowthIndicator
  gender    WhoGender
  
  // Discriminator: One of these must be set depending on indicator
  ageDays        Int?               @map("age_days")
  lengthHeightCm Decimal?           @map("length_height_cm") @db.Decimal(8, 2)
  
  l         Decimal            @db.Decimal(12, 8)
  m         Decimal            @db.Decimal(12, 8)
  s         Decimal            @db.Decimal(12, 8)
  
  sd4Neg    Decimal?           @map("sd4_neg") @db.Decimal(12, 8)
  sd3Neg    Decimal?           @map("sd3_neg") @db.Decimal(12, 8)
  sd2Neg    Decimal?           @map("sd2_neg") @db.Decimal(12, 8)
  sd1Neg    Decimal?           @map("sd1_neg") @db.Decimal(12, 8)
  sd0       Decimal            @map("sd0") @db.Decimal(12, 8)
  sd1       Decimal?           @map("sd1") @db.Decimal(12, 8)
  sd2       Decimal?           @map("sd2") @db.Decimal(12, 8)
  sd3       Decimal?           @map("sd3") @db.Decimal(12, 8)
  sd4       Decimal?           @map("sd4") @db.Decimal(12, 8)
  
  createdAt DateTime           @default(now()) @map("created_at") @db.Timestamp(6)

  @@index([indicator, gender, ageDays, lengthHeightCm], map: "idx_who_lookup")
  @@map("who_growth_standards")
}

// ============================================================
// SYSTEM OBSERVABILITY
// ============================================================

enum MetricType {
  VERCEL_BANDWIDTH
  VERCEL_INVOCATIONS
  NEON_STORAGE
  NEON_COMPUTE
  NEON_CONNECTIONS
  UPSTASH_COMMANDS
  UPSTASH_DATA_SIZE
  APP_REQUEST_COUNT
  APP_ERROR_COUNT
  APP_AVG_LATENCY
  APP_COLD_STARTS
  AUTH_MAU
  AUTH_ATTEMPTS
  DATA_FRESHNESS
}

enum ProviderType {
  VERCEL
  RENDER
  NEON
  UPSTASH
  FIREBASE
  INTERNAL
}

enum MetricStatus {
  VALID
  ESTIMATED
  FAILED_FETCH
  PARTIAL
}

model SystemMetric {
  id          BigInt     @id @default(autoincrement())
  timestamp   DateTime   @default(now()) @map("timestamp") @db.Timestamp(6)
  
  type        MetricType
  provider    ProviderType
  source      String     @db.VarChar(50)
  status      MetricStatus
  
  value       Decimal    @db.Decimal(18, 4)
  limit       Decimal?   @db.Decimal(18, 4)
  unit        String     @db.VarChar(20)
  
  windowStart DateTime?  @map("window_start")
  windowEnd   DateTime?  @map("window_end")
  
  collectionDurationMs Int? @map("collection_duration_ms")
  payloadHash String?    @map("payload_hash")
  
  meta        Json?

  @@index([timestamp, type, provider], map: "idx_metrics_lookup")
  @@map("system_metrics")
}

model SystemMetricDerived {
  id                  BigInt   @id @default(autoincrement())
  computedAt          DateTime @default(now()) @map("computed_at")
  metricType          MetricType
  provider            ProviderType
  source              String   @db.VarChar(50)
  
  daysRemaining       Decimal? @map("days_remaining") @db.Decimal(10, 2)
  projectedCost       Decimal? @map("projected_cost") @db.Decimal(10, 2)
  anomalyScore        Decimal? @map("anomaly_score") @db.Decimal(5, 4)
  predictionConfidence Decimal? @map("prediction_confidence") @db.Decimal(5, 4)

  @@index([metricType, provider, computedAt], map: "idx_derived_lookup")
  @@map("system_metrics_derived")
}

// ============================================================
// CLINICAL ENGINE (DETERMINISTIC)
// ============================================================

model ClinicalDisease {
  id          String   @id @db.VarChar(50) // e.g. 'DENGUE'
  name        String   @db.VarChar(100)    // e.g. 'Demam Berdarah Dengue'
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  decisionTrees ClinicalDecisionTree[]

  @@map("clinical_diseases")
}

model ClinicalDecisionTree {
  id          Int      @id @default(autoincrement())
  diseaseId   String   @map("disease_id") @db.VarChar(50)
  version     String   @db.VarChar(20)    // e.g. '1.0.0'
  isActive    Boolean  @default(false) @map("is_active")
  
  // Artifact A: The Raw Spec (source of truth for the generator)
  clinicalSpec Json    @map("clinical_spec") 
  
  // Artifact B: The Executable Graph (source of truth for the engine)
  treeNodes    Json    @map("tree_nodes") 
  
  // Metadata for Governance
  commitNote   String?  @map("commit_note") @db.Text
  specHash     String   @map("spec_hash") @db.VarChar(64) // SHA-256 for integrity

  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  createdBy    Int?     @map("created_by")
  
  reviewerId   Int?     @map("reviewer_id")
  approvedAt   DateTime? @map("approved_at") @db.Timestamp(6)

  disease      ClinicalDisease @relation(fields: [diseaseId], references: [id], onDelete: Cascade)
  creator      User?           @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  reviewer     User?           @relation("tree_reviews", fields: [reviewerId], references: [id], onDelete: SetNull)

  @@unique([diseaseId, version], map: "uq_clinical_tree_version")
  @@index([isActive], map: "idx_clinical_tree_active")
  @@map("clinical_decision_trees")
}

// ============================================================
// PHASE 10: LLM EXPANSION PROPOSALS
// ============================================================

model TreeExpansionProposal {
  id          Int      @id @default(autoincrement())
  diseaseId   String   @map("disease_id") @db.VarChar(50)
  baseVersion String   @map("base_version") @db.VarChar(50)
  
  proposedSpec Json    @map("proposed_spec")
  proposedNodes Json   @map("proposed_nodes")
  
  status      String   @default("PENDING") @db.VarChar(20) // PENDING, APPROVED, REJECTED
  
  generatedBy String?  @map("generated_by") @db.VarChar(100) // LLM model identifier
  reviewedBy  Int?     @map("reviewed_by")
  reviewNotes String?  @map("review_notes") @db.Text
  
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  reviewedAt  DateTime? @map("reviewed_at") @db.Timestamp(6)
  
  reviewer    User?    @relation("tree_expansion_reviewer", fields: [reviewedBy], references: [id], onDelete: SetNull)
  
  @@map("tree_expansion_proposals")
}
